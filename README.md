# Kunstdatabasen


[![Woodpecker](https://img.shields.io/badge/woodpecker-prod|stg-blue.svg?style=flat-square&logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTEuMjYzIDIuNzQ0QzIuNDEgMy44MzIgMi44NDUgNC45MzIgNC4xMTggNS4wOGwuMDM2LjAwN2MtLjU4OC42MDYtMS4wOSAxLjQwMi0xLjQ0MyAyLjQyMy0uMzggMS4wOTYtLjQ4OCAyLjI4NS0uNjE0IDMuNjU5LS4xOSAyLjA0Ni0uNDAxIDQuMzY0LTEuNTU2IDcuMjY5LTIuNDg2IDYuMjU4LTEuMTIgMTEuNjMuMzMyIDE3LjMxNy42NjQgMi42MDQgMS4zNDggNS4yOTcgMS42NDIgOC4xMDdhLjg1Ny44NTcgMCAwMC42MzMuNzQ0Ljg2Ljg2IDAgMDAuOTIyLS4zMjNjLjIyNy0uMzEzLjUyNC0uNzk3Ljg2LTEuNDI0Ljg0IDMuMzIzIDEuMzU1IDYuMTMgMS43ODMgOC42OTdhLjg2Ni44NjYgMCAwMDEuNTE3LjQxYzIuODgtMy40NjMgMy43NjMtOC42MzYgMi4xODQtMTIuNjc0LjQ1OS0yLjQzMyAxLjQwMi00LjQ1IDIuMzk4LTYuNTgzLjUzNi0xLjE1IDEuMDgtMi4zMTggMS41NS0zLjU2Ni4yMjgtLjA4NC41NjktLjMxNC43OS0uNDQxbDEuNzA3LS45ODEtLjI1NiAxLjA1MmEuODY0Ljg2NCAwIDAwMS42NzguNDA4bC42OC0yLjg1OCAxLjI4NS0yLjk1YS44NjMuODYzIDAgMTAtMS41ODEtLjY4N2wtMS4xNTIgMi42NjktMi4zODMgMS4zNzJhMTguOTcgMTguOTcgMCAwMC41MDgtMi45ODFjLjQzMi00Ljg2LS43MTgtOS4wNzQtMy4wNjYtMTEuMjY2LS4xNjMtLjE1Ny0uMjA4LS4yODEtLjI0Ny0uMjYuMDk1LS4xMi4yNDktLjI2LjM1OC0uMzc0IDIuMjgzLTEuNjkzIDYuMDQ3LS4xNDcgOC4zMTkuNzUuNTg5LjIzMi44NzYtLjMzNy4zMTYtLjY3LTEuOTUtMS4xNTMtNS45NDgtNC4xOTYtOC4xODgtNi4xOTMtLjMxMy0uMjc1LS41MjctLjYwNy0uODktLjkxM0M5LjgyNS41NTUgNC4wNzIgMy4wNTcgMS4zNTUgMi41NjljLS4xMDItLjAxOC0uMTY2LjEwMy0uMDkyLjE3NW0xMC45OCA1Ljg5OWMtLjA2IDEuMjQyLS42MDMgMS44LTEgMi4yMDgtLjIxNy4yMjQtLjQyNi40MzYtLjUyNC43MzgtLjIzNi43MTQuMDA4IDEuNTEuNjYgMi4xNDMgMS45NzQgMS44NCAyLjkyNSA1LjUyNyAyLjUzOCA5Ljg2LS4yOTEgMy4yODgtMS40NDggNS43NjMtMi42NzEgOC4zODUtMS4wMzEgMi4yMDctMi4wOTYgNC40ODktMi41NzcgNy4yNTlhLjg1My44NTMgMCAwMC4wNTYuNDhjMS4wMiAyLjQzNCAxLjEzNSA2LjE5Ny0uNjcyIDkuNDZhOTYuNTg2IDk2LjU4NiAwIDAwLTEuOTctOC43MTFjMS45NjQtNC40ODggNC4yMDMtMTEuNzUgMi45MTktMTcuNjY4LS4zMjUtMS40OTctMS4zMDQtMy4yNzYtMi4zODctNC4yMDctLjIwOC0uMTgtLjQwMi0uMjM3LS40OTUtLjE2Ny0uMDg0LjA2LS4xNTEuMjM4LS4wNjIuNDQ0LjU1IDEuMjY2Ljg3OSAyLjU5OSAxLjIyNiA0LjI3NiAxLjEyNSA1LjQ0My0uOTU2IDEyLjQ5LTIuODM1IDE2Ljc4MmwtLjExNi4yNTktLjQ1Ny45ODJjLS4zNTYtMi4wMTQtLjg1LTMuOTUtMS4zMy01Ljg0LTEuMzgtNS40MDYtMi42OC0xMC41MTUtLjQwMS0xNi4yNTQgMS4yNDctMy4xMzcgMS40ODMtNS42OTIgMS42NzItNy43NDYuMTE2LTEuMjYzLjIxNi0yLjM1NS41MjYtMy4yNTIuOTA1LTIuNjA1IDMuMDYyLTMuMTc4IDQuNzQ0LTIuODUyIDEuNjMyLjMxNiAzLjI0IDEuNTkzIDMuMTU2IDMuNDJ6bS0yLjg2OC42MmExLjE3NyAxLjE3NyAwIDEwLjczNi0yLjIzNiAxLjE3OCAxLjE3OCAwIDEwLS43MzYgMi4yMzd6Ii8+PC9zdmc+Cg==)](https://woodpecker.itkdev.dk/repos/9)
[![GitHub Release](https://img.shields.io/github/v/release/itk-dev/kunstdatabasen?style=flat-square&logo=data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIj48IS0tIUZvbnQgQXdlc29tZSBGcmVlIDYuNy4yIGJ5IEBmb250YXdlc29tZSAtIGh0dHBzOi8vZm9udGF3ZXNvbWUuY29tIExpY2Vuc2UgLSBodHRwczovL2ZvbnRhd2Vzb21lLmNvbS9saWNlbnNlL2ZyZWUgQ29weXJpZ2h0IDIwMjUgRm9udGljb25zLCBJbmMuLS0+PHBhdGggZmlsbD0iI2ZmZiIgZD0iTTAgODBMMCAyMjkuNWMwIDE3IDYuNyAzMy4zIDE4LjcgNDUuM2wxNzYgMTc2YzI1IDI1IDY1LjUgMjUgOTAuNSAwTDQxOC43IDMxNy4zYzI1LTI1IDI1LTY1LjUgMC05MC41bC0xNzYtMTc2Yy0xMi0xMi0yOC4zLTE4LjctNDUuMy0xOC43TDQ4IDMyQzIxLjUgMzIgMCA1My41IDAgODB6bTExMiAzMmEzMiAzMiAwIDEgMSAwIDY0IDMyIDMyIDAgMSAxIDAtNjR6Ii8+PC9zdmc+)](https://github.com/itk-dev/kunstdatabasen/releases)
[![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/itk-dev/kunstdatabasen/pr.yaml?style=flat-square&logo=github)](https://github.com/itk-dev/kunstdatabasen/actions/workflows/pr.yaml)
[![Codecov](https://img.shields.io/codecov/c/github/itk-dev/kunstdatabasen?style=flat-square&logo=codecov)](https://codecov.io/gh/itk-dev/kunstdatabasen)
[![GitHub last commit](https://img.shields.io/github/last-commit/itk-dev/kunstdatabasen?style=flat-square)](https://github.com/itk-dev/kunstdatabasen/commits/develop/)
[![GitHub License](https://img.shields.io/github/license/itk-dev/kunstdatabasen?style=flat-square)](https://github.com/itk-dev/kunstdatabasen/blob/develop/LICENSE)

## Production

## Upgrade from version 1.5.2

```sh
# Upgrade migrations
itkdev-docker-compose bin/console doctrine:migrations:list
itkdev-docker-compose bin/console doctrine:migrations:sync-metadata-storage
itkdev-docker-compose bin/console doctrine:migrations:version --add --all --no-interaction
itkdev-docker-compose bin/console doctrine:migrations:list
itkdev-docker-compose-server pull
itkdev-docker-compose-server up --detach --remove-orphans
itkdev-docker-compose-server exec phpfpm composer install --no-dev --no-scripts
# Upgrade migrations (only once)
itkdev-docker-compose-server exec phpfpm bin/console doctrine:migrations:list
itkdev-docker-compose-server exec phpfpm bin/console doctrine:migrations:sync-metadata-storage
itkdev-docker-compose-server exec phpfpm bin/console doctrine:migrations:version --add --all --no-interaction
# Remove our single new migration
itkdev-docker-compose-server exec phpfpm bin/console doctrine:migrations:version --delete 'DoctrineMigrations\Version20230801120357' --no-interaction
itkdev-docker-compose-server exec phpfpm bin/console doctrine:migrations:list
```

## Install/update

```sh
# Edit .env.local
APP_SECRET=…

SUPPORT_MAIL=…
SITEIMPROVE_KEY=…
WEB_ACCESSIBILITY_STATEMENT_URL=…

# Install
itkdev-docker-compose-server pull
itkdev-docker-compose-server up --detach --remove-orphans
itkdev-docker-compose-server exec phpfpm composer install --no-dev
itkdev-docker-compose-server exec phpfpm bin/console doctrine:migrations:migrate --no-interaction

# Build assets using our development setup
docker compose run --rm node yarn install
docker compose run --rm node yarn build
# Clean up
rm -fr node_modules

itkdev-docker-compose-server exec phpfpm bin/console cache:clear --no-interaction
```

This site comes with an docker setup to do local developement.

## Running the docker setup

The default `.env` file that comes with the project is configured out-of-the-box
to match the docker setup.

```sh
# Create the frontend network if it does not already exist.
docker network inspect frontend 2>&1 > /dev/null || docker network create frontend
docker compose pull
docker compose up --detach

# Install
docker compose exec phpfpm composer install

# Run migrations
docker compose exec phpfpm bin/console doctrine:migrations:migrate --no-interaction
```

### Load fixtures

To ease the development on local setup the project supplies fixtures:

```sh
docker compose exec phpfpm bin/console hautelook:fixtures:load --no-bundles
```

### Refresh tags

```sh
docker compose exec phpfpm bin/console app:refresh-tags
```

### Open site

```sh
open "http://$(docker compose port nginx 8080)"
```

Open the administration interface:

```sh
open "http://$(docker compose port nginx 8080)/admin"
```

Sign in as `admin@example.com` with password `admin` if fixtures have been
loaded.

### Create an admin user

```sh
docker compose exec phpfpm bin/console app:create-user
```

### Browsersync

For testing and to auto-reload browser you can run
[Browsersync](https://browsersync.io/) with

```sh
browser-sync start --config bs-config.js
```

## Build the frontend

We use [Webpack
Encore](https://symfony.com/doc/current/frontend.html#frontend-webpack-encore)
to build frontend assets.

```sh
# Install dependencies
docker compose run --rm node yarn install
# Build assets
docker compose run --rm node yarn build
```

During development you can watch for changes:

```sh
docker compose run --rm node yarn watch
```

## Migration in production

Run the migration command:

```sh
docker compose exec phpfpm bin/console app:import-spreadsheet var/migration.xls
docker compose exec phpfpm bin/console app:refresh-tags
```

Add image files in a folder (`public/images/migration_images`) each named after
the inventoryId they match, eg.`1000.jpg`.

Attach images to Items

```sh
docker compose exec phpfpm bin/console app:import-images public/images/migration_images
```

Build frontend assets:

```sh
docker compose run --rm node yarn build
```

### Coding standards

```sh
docker compose exec phpfpm composer coding-standards-check
```

```sh
docker compose run --rm prettier 'assets/' --write
docker compose run --rm prettier 'assets/' --check
```
